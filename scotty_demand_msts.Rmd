---
title: "Demand Forecasting of Scotty Ride-sharing Service"
author: "by Gabriel Erichson"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: true
    number_sections: true
    theme: sandstone
    highlight: haddock
    css:  style.css
  pdf_document: default
---

<head>
		<title>Mobile Price Classification</title>
		<link rel="icon" href="assets/logo.png" type="image/png">
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE,
	comment = "#>",
	result = "hide"
)

options(scipen = 9999999)
#rm(list=ls())

#Data Wrangling and Visualization
library(Rcpp)
library(tidyverse)
library(ggplot2)
library(plotly)
library(scales)
library(tidyquant)
library(glue)
library(ggthemes)
library(paletti)
library(kableExtra)

#Time Series
library(lubridate)
library(padr)

```


# Intro

Scotty Technologies Inc. ("Scotty") adalah sebuah perusahaan start-up teknologi yang didirikan pada tahun 2017 di Istanbul, Turkey. Salah satu layanan utama dari Scotty adalah *motorcycle ride-sharing* atau yang akrab kita ketahui *Ojek Online*.
Menurut informasi yang dilansir dari [markets.businessinsider.com](https://markets.businessinsider.com/news/stocks/bcap-invests-in-turkish-rideshare-company-scotty-1028819466), Scotty berencana untuk menjadi super-app pertama di Turkey dengan tekonologi dan model bisnis yang distruptif, serta berencana untuk melanjutkan pertumbuhan yang menjanjikan dan mencapai profitabilitas dalam waktu dekat. Berbicara mengenai pertumbuhan, tentu saja tidak luput dari demand. Oleh karena itu, projek ini ditujukan untuk membuat model analisa dan memprediksi demand transaksi per-jam pada layanan motorcycle ride-sharing di Scotty. Dalam proses pembuatan model ini, kita menggunakan data transaksi Scotty dari 2017-10-01 sampai 2017-12-02. <br>


# Data Preparation
## Read Data
```{r}
scotty_ts <- read.csv("data_input/scotty_ts/data-train.csv")
```

**5 Top Line Data**
```{r}
head(scotty_ts)
```

<br>
**5 Bottom Line Data**
```{r}
tail(scotty_ts,5)
```

***

<br>

## Variable Description

Variable              | Description
----------------------|------------------------------------------------------------
id                    | Transaction id
trip_id               | Trip id
driver_id             | Driver id
rider_id              | Rider id
start_time            | Transaction Time
src_lat               | Request source latitude
src_lon               | Request source longitude
src_area              | Request source area
src_sub_area          | Request source sub-area
dest_lat              | Requested destination latitude
dest_lon              | Requested destination longitude
dest_area             | Requested destination area
dest_sub_area         | Requested destination sub-area
distance              | Trip distance (in KM)
status                | Trip status (all status considered as a demand)
confirmed_time_sec    | Time different from request to confirmed (in seconds)

***

<br>

## Missing & Duplicate Value?
**Missing Value**
Jika dilihat terdapat missing value pada variabel **trip_id** dan **driver_id**, namun tidak menjadi masalah karena pada case ini kita butuh data waktu dan demand.
```{r}
colSums(is.na(scotty_ts))
```
<br>

**Duplicate Value**
Dataset ini tidak memiliki data transaksi yang duplikat, sehingga bisa kita lanjutkan ke tahap pre-processing.
```{r}
data.frame(jumlah.observasi.awal=length(scotty_ts$id),
           jumlah.observasi.unik=length(unique(scotty_ts$id)))
```

***

<br>

# Data Pre-processing
## Data Structure
```{r}
glimpse(scotty_ts)
```

Dataset yang dimiliki terdiri dari **90.133** observasi dan **16** variabel. Jika dilihat dari struktur datanya, beberapa variabel memiliki tipe data yang belum sesuai. Namun, karena projek ini bertujuan untuk melakukan time-series forecasting terhadap demand per-jam pada layanan motorcycle ride-sharing di Scotty, maka data yang kita perlukan adalah waktu transaksi per-jam dan demand pada setiap src_sub_area. Maka dari Berikut prosesnya:

```{r}
scotty_ts <- scotty_ts %>% 
   mutate(
      # Transaksi Per-Jam
      datetime = floor_date(ymd_hms(start_time), unit="hour")
   ) %>% 
   group_by(src_sub_area, datetime) %>% 
   summarise(demand = length(status)) %>% 
   ungroup()
```


## Missing Series Datetime Value
Dalam melakukan analisa dan prediksi time series maka seluruh data waktu harus lengkap secara sekuensial. Jam opearasional Scotty yaitu 24jam/hari, sehingga kita harus memastikan seluruh data jam sudah lengkap secara sekuensial dari rentang tanggal minimum hingga tanggal maximum.

```{r, warning=FALSE, error=FALSE}
scotty_ts <- scotty_ts %>% 
  group_by(src_sub_area) %>% 
  # PAD tanggal sekuensial
  padr::pad(start_val = min(scotty_ts$datetime), end_val = max(scotty_ts$datetime)) %>% 
  ungroup() %>% 
  distinct() %>% 
  mutate(
    # replace NA Value menjadi 0
    demand = ifelse(is.na(demand),0,demand)
  )
```

Berikut ini visualisasi dataset denagan data waktu yang lengkap dan sekuensial. Titik/Poin berwarna merah, hijau dan biru menandakan data pada jam tersebut tidak ada dan mari kita asumsikan bahwa pada jam tersebut memang tidak terdapat transaksi, sehingga **jumlah demand = 0**.

```{r, fig.width=8.5, fig.asp=0.75}

scotty_demand <- scotty_ts %>% 
    mutate(
      weekdays = weekdays(datetime),
      popup = glue(
      "Category: {src_sub_area}
      Transaction Time: {datetime}
      Day: {weekdays}
      Demand: {demand}"
    )) 

plot_scotty_demand <- ggplot(scotty_demand,aes(x=datetime, y=demand),show.legend = FALSE)+
   #geom_point()+
  
  geom_line(show.legend = FALSE,size=0.3)+
  geom_point(aes(text=popup),size=0.05)+
  geom_point(data = scotty_demand %>% filter(demand==0),
             aes(x=datetime, y=demand, color=src_sub_area, text=popup),size=1, show.legend = FALSE)+
  labs(
    x = NULL, 
    y = NULL,
    title = "Demand by Sub Area"
  ) +
  scale_x_datetime(date_breaks = "7 day", labels = date_format("%b %d"))+
  facet_wrap(~ src_sub_area, scale = "free", ncol = 1)+
  theme(
    legend.position = "none", 
    plot.title = element_text(hjust = 0.5),
    panel.spacing = unit(1, "lines"))+
  tidyquant::theme_tq()

ggplotly(p = plot_scotty_demand, tooltip="text") %>% 
  layout(showlegend=FALSE)
  #config(displayModeBar = F, scrollzoom = T) %>% 
  #layout(dragmode = "pan")
 
```


## Data Summary
```{r}
summary(scotty_ts)
```

Informasi di atas merupakan summary keseluruhan data yang kita miliki. Dapat diketahui bahwa dataset ini merupakan data transaksi dari 3 sub area yaitu **sxk97, sxk9e dan sxk9s** yang terjadi dari **2017-10-01 00:00** sampai **2017-12-02 23:00** dengan **jumlah minimum 0 demand**  dan **jumlah maximum 217 demand**. Demand 0 dapat diasumsikan bahwa pada waktu tertentu memang tidak terdapat transaksi. 





